# 属性平衡成就系统修改清单

## ✅ 已完成的修改

### 1. 数据文件修改
- [x] `src/data/achievements.ts` - 修改成就数据
  - 删除 16 个大师系列成就（鼓励偏科）
  - 修改 10 个成就的要求和描述
  - 新增 2 个先行者成就（MNG、CRE）
  - 更新系列描述

### 2. 状态管理修改
- [x] `src/store/gameStore.ts` - 更新成就检测逻辑
  - 移除大师系列成就检测代码
  - 更新守护者系列成就检测逻辑
  - 新增先行者成就检测（4个属性）
  - 新增黄金比例成就检测
  - 更新至高守护者检测（增加差值限制）

### 3. 文档创建
- [x] `属性平衡成就修改说明.md` - 详细修改说明
- [x] `属性平衡成就修改总结.md` - 修改总结和实施指南
- [x] `修改清单.md` - 本文件

---

## 🔄 需要进一步完善的部分

### 1. 成就检测逻辑完善
需要在 `gameStore.ts` 中添加更多成就的检测逻辑：

#### 极限挑战系列
- [ ] `extreme_all_balanced` - 所有属性≥150且差值≤10

#### 完美主义系列
- [ ] `perfect_all_attributes_max` - 所有属性≥100且差值≤10

#### 数字艺术家系列
- [ ] `digit_attribute_88` - 所有属性≥88（已通过comboRequirement处理）

#### 速度系列
- [ ] `speed_attribute_boost` - 单日所有属性各+5（需要追踪单日属性变化）

#### 传奇系列
- [ ] `legendary_ultimate` - 需要增加差值≤10的检查

---

## 📝 建议的后续工作

### 阶段1: 核心功能完善（优先级：高）

#### 1.1 完善成就检测逻辑
```typescript
// 在 gameStore.ts 的 checkAchievements 方法中添加

// 极限平衡 - 所有属性≥150且差值≤10
else if (achievement.id === 'extreme_all_balanced') {
  const attrValues = Object.values(state.attributes);
  const allAbove150 = attrValues.every(v => v >= 150);
  const max = Math.max(...attrValues);
  const min = Math.min(...attrValues);
  shouldUnlock = allAbove150 && (max - min) <= 10;
}

// 和谐共生 - 所有属性≥100且差值≤10
else if (achievement.id === 'perfect_all_attributes_max') {
  const attrValues = Object.values(state.attributes);
  const allAbove100 = attrValues.every(v => v >= 100);
  const max = Math.max(...attrValues);
  const min = Math.min(...attrValues);
  shouldUnlock = allAbove100 && (max - min) <= 10;
}

// 终极传奇 - 需要增加差值检查
else if (achievement.id === 'legendary_ultimate') {
  const attrValues = Object.values(state.attributes);
  const allAbove100 = attrValues.every(v => v >= 100);
  const max = Math.max(...attrValues);
  const min = Math.min(...attrValues);
  const hasRequiredAchievements = achievement.comboRequirement?.achievements?.every(
    achId => state.unlockedAchievements.includes(achId)
  ) ?? true;
  shouldUnlock = state.level >= 50 &&
                 state.stats.totalQuestsCompleted >= 500 &&
                 allAbove100 &&
                 (max - min) <= 10 &&
                 hasRequiredAchievements;
}
```

#### 1.2 添加属性变化追踪
为了支持"单日属性增长"类成就，需要添加每日属性变化追踪：

```typescript
// 在 GameStore 接口中添加
interface GameStore {
  // ... 现有字段
  dailyAttributeChanges?: {
    date: string;
    changes: {
      int: number;
      vit: number;
      mng: number;
      cre: number;
    };
  };
}

// 在 addAttribute 方法中记录变化
addAttribute: (type: AttributeType, amount: number) => {
  const today = new Date().toISOString().split('T')[0];
  const state = get();

  // 初始化或重置每日变化记录
  if (!state.dailyAttributeChanges || state.dailyAttributeChanges.date !== today) {
    set({
      dailyAttributeChanges: {
        date: today,
        changes: { int: 0, vit: 0, mng: 0, cre: 0 }
      }
    });
  }

  // 记录变化
  set(state => ({
    dailyAttributeChanges: {
      ...state.dailyAttributeChanges!,
      changes: {
        ...state.dailyAttributeChanges!.changes,
        [type]: state.dailyAttributeChanges!.changes[type] + amount
      }
    }
  }));

  // ... 原有的属性增加逻辑
}
```

---

### 阶段2: 用户界面优化（优先级：中）

#### 2.1 成就详情页增强
在 `AchievementsPage.tsx` 中添加：
- [ ] 显示当前属性状态
- [ ] 显示属性差值
- [ ] 显示距离达成的提示
- [ ] 用颜色标识最高/最低属性

#### 2.2 属性平衡度可视化
创建新组件 `AttributeBalanceRadar.tsx`：
- [ ] 雷达图展示四项属性
- [ ] 平衡度评分（0-100）
- [ ] 推荐的发展方向

#### 2.3 成就进度提示优化
- [ ] "还需要提升 X 点最低属性"
- [ ] "当前差值为 X，需要控制在 Y 以内"
- [ ] "其他属性需要达到 70 以上"

---

### 阶段3: 数据迁移和兼容性（优先级：中）

#### 3.1 老玩家数据处理
创建迁移脚本 `migrations/achievement-balance-update.ts`：

```typescript
export function migrateAchievementBalanceUpdate(state: GameStore): GameStore {
  const deletedAchievements = [
    'int_master_i', 'int_master_ii', 'int_master_iii', 'int_master_iv',
    'vit_master_i', 'vit_master_ii', 'vit_master_iii', 'vit_master_iv',
    'mng_master_i', 'mng_master_ii', 'mng_master_iii', 'mng_master_iv',
    'cre_master_i', 'cre_master_ii', 'cre_master_iii', 'cre_master_iv',
  ];

  // 统计被删除的成就
  const deletedCount = state.unlockedAchievements.filter(
    id => deletedAchievements.includes(id)
  ).length;

  // 移除已删除的成就
  const newUnlockedAchievements = state.unlockedAchievements.filter(
    id => !deletedAchievements.includes(id)
  );

  // 计算补偿
  const compensation = {
    exp: deletedCount * 200,  // 每个成就补偿200经验
    coins: deletedCount * 100, // 每个成就补偿100金币
  };

  return {
    ...state,
    unlockedAchievements: newUnlockedAchievements,
    currentExp: state.currentExp + compensation.exp,
    coins: state.coins + compensation.coins,
  };
}
```

#### 3.2 版本标记
在 `gameStore.ts` 中添加版本号：

```typescript
const initialState = {
  // ... 现有字段
  dataVersion: '2.0.0', // 标记数据版本
};
```

---

### 阶段4: 测试和验证（优先级：高）

#### 4.1 单元测试
创建 `__tests__/achievements.test.ts`：

```typescript
describe('属性平衡成就检测', () => {
  test('智慧引领 - 正常情况', () => {
    const attributes = { int: 90, vit: 70, mng: 70, cre: 70 };
    expect(checkLeadingAchievement('int', attributes)).toBe(true);
  });

  test('智慧引领 - 其他属性过低', () => {
    const attributes = { int: 90, vit: 69, mng: 70, cre: 70 };
    expect(checkLeadingAchievement('int', attributes)).toBe(false);
  });

  test('智慧引领 - 差值过大', () => {
    const attributes = { int: 100, vit: 70, mng: 70, cre: 70 };
    expect(checkLeadingAchievement('int', attributes)).toBe(false);
  });

  test('黄金比例 - 正常情况', () => {
    const attributes = { int: 80, vit: 75, mng: 70, cre: 85 };
    expect(checkBalanceAchievement(attributes, 20, 60)).toBe(true);
  });

  test('极限平衡 - 正常情况', () => {
    const attributes = { int: 150, vit: 150, mng: 145, cre: 150 };
    expect(checkBalanceAchievement(attributes, 10, 150)).toBe(true);
  });
});
```

#### 4.2 集成测试
- [ ] 测试成就解锁流程
- [ ] 测试成就撤销流程
- [ ] 测试属性变化后的成就检测

#### 4.3 用户测试
- [ ] 邀请测试用户体验新系统
- [ ] 收集反馈
- [ ] 调整数值平衡

---

### 阶段5: 游戏平衡性调整（优先级：中）

#### 5.1 任务奖励调整
修改任务完成时的属性奖励逻辑：

```typescript
// 在 completeQuest 方法中
const attributeRewards = calculateBalancedRewards(state.attributes, quest);

function calculateBalancedRewards(
  currentAttributes: Attributes,
  quest: Quest
): Partial<Attributes> {
  const attrValues = Object.values(currentAttributes);
  const min = Math.min(...attrValues);
  const max = Math.max(...attrValues);
  const difference = max - min;

  // 如果差值过大，优先奖励较低的属性
  if (difference > 30) {
    const lowestAttr = Object.entries(currentAttributes)
      .sort(([, a], [, b]) => a - b)[0][0] as AttributeType;
    return { [lowestAttr]: quest.reward.attributes[lowestAttr] * 1.5 };
  }

  // 正常奖励
  return quest.reward.attributes;
}
```

#### 5.2 商店道具添加
在 `rewards.ts` 中添加平衡相关道具：

```typescript
{
  id: 'balance_potion',
  name: '平衡药水',
  description: '调整属性分配，使所有属性趋于平衡',
  price: 500,
  category: 'consumable',
  effect: {
    type: 'balance_attributes',
    value: 10, // 将最高属性的10点转移到最低属性
  },
}
```

---

### 阶段6: 文档和沟通（优先级：中）

#### 6.1 用户文档更新
- [ ] 更新用户手册中的成就系统说明
- [ ] 添加"属性平衡"专题指南
- [ ] 创建FAQ解答常见问题

#### 6.2 更新公告
- [ ] 撰写更新公告
- [ ] 准备补偿说明
- [ ] 设置反馈渠道

#### 6.3 开发文档
- [ ] 更新API文档
- [ ] 更新架构文档
- [ ] 添加成就检测逻辑说明

---

## 🎯 关键指标监控

### 上线后需要监控的数据：

1. **成就达成率**
   - 先行者系列成就的达成率
   - 平衡类成就的达成率
   - 与旧系统对比

2. **属性分布**
   - 玩家属性差值的分布
   - 平衡度评分的分布
   - 偏科玩家的比例变化

3. **玩家反馈**
   - 正面/负面反馈比例
   - 常见问题和建议
   - 满意度调查结果

4. **游戏数据**
   - 平均游戏时长变化
   - 任务完成率变化
   - 留存率变化

---

## 📅 建议的实施时间表

### 第1周：核心功能完善
- 完善成就检测逻辑
- 添加属性变化追踪
- 编写单元测试

### 第2周：界面优化
- 成就详情页增强
- 属性平衡度可视化
- 进度提示优化

### 第3周：数据迁移和测试
- 实现数据迁移脚本
- 集成测试
- 内部测试

### 第4周：用户测试和调整
- 邀请测试用户
- 收集反馈
- 调整数值平衡

### 第5周：文档和发布准备
- 更新文档
- 撰写公告
- 准备发布

### 第6周：正式发布
- 发布更新
- 监控数据
- 快速响应问题

---

## ⚠️ 风险和应对措施

### 风险1：玩家不适应新系统
**应对措施**：
- 提供详细的教程和引导
- 设置过渡期，给予适应时间
- 提供"属性重置"功能

### 风险2：平衡难度过高
**应对措施**：
- 根据数据调整数值要求
- 提供更多帮助工具（平衡药水等）
- 降低初期成就的要求

### 风险3：老玩家流失
**应对措施**：
- 给予充分的补偿
- 保留已获得的称号
- 积极沟通，解释设计理念

### 风险4：技术问题
**应对措施**：
- 充分测试
- 准备回滚方案
- 设置监控和告警

---

## 📞 联系和支持

如有问题或建议，请联系：
- 开发团队：[邮箱/Discord]
- 问题反馈：GitHub Issues
- 社区讨论：[论坛/Discord]

---

**最后更新**: 2026-01-22
**文档版本**: v1.0
**负责人**: Claude Code (Sonnet 4.5)
