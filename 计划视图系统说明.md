# 系统更新说明 v2.0

## 🎉 更新概述

本次更新修复了签到日历bug，并新增了功能强大的计划视图系统，大幅提升任务管理能力！

---

## ✅ Bug 修复

### 1. 签到日历日期显示错误

**问题描述**：
- 用户在 1月4日签到，但日历显示 1月5日亮起

**修复方案**：
- 修复了日期格式化时的时区问题
- 使用本地时间代替 UTC 时间
- 统一日期比较逻辑

**修复文件**：
- `src/components/DailyCheckIn.tsx`

**修复方法**：
```typescript
// 新增本地日期格式化函数
const formatLocalDate = (date: Date): string => {
  const year = date.getFullYear();
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  return `${year}-${month}-${day}`;
};

// 创建日期时设置为中午12点避免时区问题
days.push(new Date(year, month, i, 12, 0, 0));
```

---

## 🆕 新功能

### 1. 任务系统优化

#### 新增任务属性

任务现在支持更多属性，帮助你更好地管理计划：

| 属性 | 说明 | 用途 |
|------|------|------|
| `startDate` | 开始时间 | 定义任务开始时间 |
| `endDate` | 结束时间 | 定义任务结束时间 |
| `color` | 任务颜色 | 可视化区分不同类型任务 |
| `tags` | 标签列表 | 给任务添加分类标签 |
| `progress` | 进度百分比 | 跟踪任务完成进度 (0-100) |
| `priority` | 优先级 | low / medium / high / urgent |
| `subtasks` | 子任务列表 | 将大任务拆分为小任务 |
| `recurrence` | 重复模式 | 设置任务重复规则 |
| `estimatedDuration` | 预估时长 | 任务预计耗时（分钟） |
| `actualDuration` | 实际时长 | 实际完成耗时（分钟） |

#### 新增任务管理方法

```typescript
// 更新任务
updateQuest(questId, { color: '#3b82f6', priority: 'high' });

// 更新任务进度
updateQuestProgress(questId, 75); // 75%

// 添加子任务
addSubtask(questId, '子任务标题');

// 切换子任务状态
toggleSubtask(questId, subtaskId);
```

#### 自动进度计算

- 当所有子任务完成时，主任务自动标记为完成
- 子任务完成比例自动反映到主任务进度条
- 进度达到 100% 自动完成任务

---

### 2. 计划视图系统 📅

全新的计划视图系统，支持四种视图模式切换，帮助你从不同维度管理任务！

#### 四种视图模式

##### 🌞 日视图 (Day View)
- 24小时时间轴显示
- 按小时展示任务
- 区分已安排和未安排任务
- 适合每日计划管理

##### 📆 周视图 (Week View)
- 以周为单位显示任务
- 7天网格布局
- 每天显示任务卡片
- 高亮显示今天
- 进度条可视化
- 适合每周工作规划

##### 🗓️ 月视图 (Month View)
- 日历形式展示整月任务
- 按日期分组任务
- 颜色条表示任务（最多显示3个）
- 超过3个任务显示数量提示
- 高亮今天日期
- 适合月度目标管理

##### 📋 年视图 (Year View)
- 12个月概览
- 每月任务数量统计
- 热力图样式（任务越多颜色越深）
- 快速了解全年任务分布
- 适合年度计划回顾

#### 核心功能

##### 视图切换
- 一键切换日/周/月/年视图
- 平滑过渡动画
- 保持当前选中日期

##### 日期导航
- 上一个/下一个周期
- 快速返回今天
- 日期范围显示

##### 任务过滤
- 切换显示/隐藏已完成任务
- 根据视图模式自动过滤相关任务
- 支持按日期范围筛选

##### 任务卡片
- 显示任务优先级标识
- 显示任务标签
- 实时进度条
- 颜色编码（左侧边框）
- 开始/结束时间显示
- 完成状态标识

#### 预设配置

##### 任务颜色（10种）
```typescript
蓝色 #3b82f6    绿色 #10b981    黄色 #f59e0b
红色 #ef4444    紫色 #8b5cf6    粉色 #ec4899
青色 #06b6d4    橙色 #f97316    青绿 #14b8a6
靛蓝 #6366f1
```

##### 优先级配置
- 低优先级（灰色）
- 中优先级（蓝色）
- 高优先级（橙色）
- 紧急（红色 🔥）

##### 常用标签（15个）
```
工作 💼   学习 📚   健身 🏃   娱乐 🎮
家务 🏠   社交 👥   购物 🛒   旅行 ✈️
阅读 📖   写作 ✍️   编程 💻   运动 ⚽
饮食 🍔   睡眠 😴   冥想 🧘
```

---

## 📁 新增文件

### 核心文件

```
sys5/
├── src/
│   ├── components/
│   │   └── PlannerView.tsx          # 计划视图主组件 (700+ 行)
│   ├── data/
│   │   └── questConfig.ts           # 任务配置数据
│   ├── utils/
│   │   └── dateUtils.ts             # 日期工具函数
│   └── types/
│       └── game.ts                  # 更新了类型定义
└── 计划视图系统说明.md               # 本文档
```

### 更新文件

```
src/
├── store/
│   └── gameStore.ts                 # 添加新的任务管理方法
├── components/
│   ├── DailyCheckIn.tsx            # 修复日期bug
│   └── Navigation.tsx              # 添加计划视图入口
└── app/
    └── page.tsx                    # 集成计划视图
```

---

## 🎮 使用指南

### 访问计划视图

1. 启动开发服务器
```bash
cd sys5
npm run dev
```

2. 在左侧导航栏点击**日历图标**（CalendarDays）
3. 进入计划视图页面

### 切换视图模式

- 点击顶部的 **日/周/月/年** 按钮切换视图
- 使用左右箭头导航不同时间段
- 点击 **今天** 快速返回当前日期

### 查看任务

- **日视图**：查看每小时的任务安排
- **周视图**：查看本周7天的任务分布
- **月视图**：查看整月任务日历
- **年视图**：查看全年任务概况

### 任务管理

目前支持查看任务，后续更新将添加：
- 拖拽调整任务时间
- 直接在视图中创建任务
- 快速编辑任务属性
- 任务进度更新

---

## 💡 技术实现

### 日期处理

使用自定义日期工具函数避免时区问题：

```typescript
// 本地日期格式化（避免UTC转换）
formatLocalDate(date: Date): string

// 获取周/月/年日期范围
getWeekRange(date: Date): { start: Date; end: Date }
getMonthRange(date: Date): { start: Date; end: Date }
getYearRange(date: Date): { start: Date; end: Date }

// 日期比较
isSameDay(date1: Date, date2: Date): boolean
isDateInRange(date: Date, start: Date, end: Date): boolean
```

### 任务过滤逻辑

```typescript
// 根据视图模式和日期范围过滤任务
filteredQuests = quests.filter(quest => {
  // 检查任务是否在当前视图的日期范围内
  if (quest.startDate && quest.endDate) {
    // 任务跨越多天的情况
  }
  // 检查开始日期或截止日期
});
```

### 性能优化

- 使用 `useMemo` 缓存计算结果
- 按需渲染任务卡片
- 虚拟滚动（未来计划）

---

## 🚀 后续计划

### 近期计划

1. **任务创建表单**
   - 可视化表单创建任务
   - 支持所有新属性设置
   - 颜色选择器
   - 标签管理

2. **拖拽功能**
   - 拖拽任务调整时间
   - 拖拽改变任务长度
   - 跨日拖拽

3. **任务编辑**
   - 点击任务卡片编辑
   - 批量操作任务
   - 快速复制任务

4. **重复任务**
   - 每日/每周/每月重复
   - 自定义重复规则
   - 自动生成重复任务

### 长期计划

1. **统计分析**
   - 任务完成率统计
   - 时间分布图表
   - 效率分析报告

2. **协作功能**
   - 分享任务给他人
   - 团队任务视图
   - 评论和讨论

3. **智能提醒**
   - 任务开始提醒
   - 截止日期提醒
   - 浏览器通知

4. **数据导入导出**
   - 导出为 iCal 格式
   - 与 Google Calendar 同步
   - CSV 导出

---

## 🛠️ 开发指南

### 添加新的任务属性

1. 在 `src/types/game.ts` 的 `Quest` 接口中添加属性
2. 在 `src/store/gameStore.ts` 中更新相关逻辑
3. 在计划视图组件中显示新属性

### 自定义颜色和标签

编辑 `src/data/questConfig.ts`：

```typescript
// 添加新颜色
export const QUEST_COLORS = {
  // ...existing colors
  myColor: { name: '我的颜色', hex: '#abc123' },
};

// 添加新标签
export const COMMON_TAGS = [
  // ...existing tags
  { name: '我的标签', color: '#abc123', icon: '🎯' },
];
```

### 修改视图布局

编辑 `src/components/PlannerView.tsx` 中的对应视图组件：
- `DayView` - 日视图
- `WeekView` - 周视图
- `MonthView` - 月视图
- `YearView` - 年视图

---

## 📊 性能数据

### 构建信息

```
Route (app)                              Size     First Load JS
┌ ○ /                                    284 kB          371 kB
└ ○ /_not-found                          873 B          88.2 kB
```

- 增加了 3 KB JavaScript（计划视图组件）
- 所有代码已优化压缩
- 支持服务端渲染（SSR）

---

## 🎨 UI 设计

### 视觉风格

- 继承 LifeRPG 的赛博朋克风格
- 毛玻璃效果卡片
- 渐变色按钮
- 流畅的动画过渡

### 响应式设计

- 移动端：单列布局
- 平板：双列布局
- 桌面端：多列布局
- 自适应字体大小

---

## ⚠️ 注意事项

1. **兼容性**
   - 需要现代浏览器支持
   - 建议使用 Chrome/Firefox/Edge 最新版

2. **数据存储**
   - 所有数据保存在 LocalStorage
   - 建议定期备份数据

3. **性能**
   - 大量任务可能影响性能
   - 建议定期清理已完成任务

---

## 🐛 已知问题

目前暂无已知问题。如遇到问题请反馈。

---

## 📞 反馈与支持

如有问题或建议，欢迎反馈！

---

**升级完成！开始使用全新的计划视图系统吧！** 🚀
